<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í•™ìƒì§„ë¡œ ìƒë‹´ ì±—ë´‡</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ======================================================= */
        /* (CSSëŠ” ì›ë³¸ê³¼ 100% ë™ì¼í•©ë‹ˆë‹¤) */
        /* ======================================================= */
        :root {
            /* Light Mode Variables */
            --bg-color-body: #f5f7fa;
            --bg-color-sidebar: #ffffff;
            --bg-color-chat-container: #ffffff;
            --bg-color-info-panel: #ffffff;
            --bg-color-header-chat: #4a90e2;
            --bg-color-header-info: #5cb85c;
            --text-color-primary: #333333;
            --text-color-secondary: #555;
            --text-color-white: #ffffff;
            --border-color: #ddd;
            --shadow-color: rgba(0,0,0,0.05);
            --chat-bubble-ai: #e5e5ea;
            --chat-bubble-user: #4a90e2;
            --chat-item-hover: #f0f0f0;
            --chat-item-active: #e1ecfa;
            --new-chat-btn-bg: #4a90e2;
            --new-chat-btn-hover-bg: #357ab8;
            --toggle-text-btn-bg: #4a90e2;
            --toggle-text-btn-hover-bg: #357ab8;
            --competition-btn-bg: #f39c12;
            --competition-btn-hover-bg: #e67e22;
            --recommendation-item-bg: #f0f8ff;
            --recommendation-item-border: #ddd;
            --info-sub-header-bg: #ffffff;
            --info-toggle-btn-bg: #e6e6e6;
            --info-toggle-btn-color: #555;
            --info-toggle-btn-border: #ccc;
            --analysis-mode-btn-bg: #4a90e2;
            --analysis-mode-btn-border: #4a90e2;
            --analysis-mode-btn-color: white;
            --keyword-card-bg: white;
            --graph-placeholder-bg: #f0f0f0;
            --graph-placeholder-border: #ccc;
            --edit-profile-btn-bg: #3498db;
            --edit-profile-btn-hover-bg: #2980b9;
            --company-btn-bg: #27ae60; 
            --company-btn-hover-bg: #2ecc71;
        }

        /* Dark Mode Variables */
        body.dark-mode {
            --bg-color-body: #1a1a2e;
            --bg-color-sidebar: #16213e;
            --bg-color-chat-container: #16213e;
            --bg-color-info-panel: #16213e;
            --bg-color-header-chat: #0f3460;
            --bg-color-header-info: #216d21;
            --text-color-primary: #e0e0e0;
            --text-color-secondary: #b0b0b0;
            --text-color-white: #ffffff;
            --border-color: #3e4a60;
            --shadow-color: rgba(0,0,0,0.2);
            --chat-bubble-ai: #0f3460;
            --chat-bubble-user: #e94560;
            --chat-item-hover: #0f3460;
            --chat-item-active: #0f3460;
            --new-chat-btn-bg: #e94560;
            --new-chat-btn-hover-bg: #f17088;
            --toggle-text-btn-bg: #e94560;
            --toggle-text-btn-hover-bg: #f17088;
            --competition-btn-bg: #f39c12;
            --competition-btn-hover-bg: #e67e22;
            --recommendation-item-bg: #2b3a5a;
            --recommendation-item-border: #3e4a60;
            --info-sub-header-bg: #16213e;
            --info-toggle-btn-bg: #3e4a60;
            --info-toggle-btn-color: #e0e0e0;
            --info-toggle-btn-border: #3e4a60;
            --analysis-mode-btn-bg: #e94560;
            --analysis-mode-btn-border: #e94560;
            --analysis-mode-btn-color: white;
            --keyword-card-bg: #2b3a5a;
            --graph-placeholder-bg: #3e4a60;
            --graph-placeholder-border: #5a6b8c;
            --edit-profile-btn-bg: #3498db;
            --edit-profile-btn-hover-bg: #2980b9;
            --company-btn-bg: #27ae60;
            --company-btn-hover-bg: #2ecc71;
        }

        body {
            background-color: var(--bg-color-body);
            font-family: "Noto Sans KR", sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .main-content-wrapper {
            flex: 1;
            display: flex;
        }

        /* ===== Sidebar (ì™¼ìª½ 1) ===== */
        .sidebar {
            width: 240px;
            background-color: var(--bg-color-sidebar);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px var(--shadow-color);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        
        .sidebar-main {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }
        
        .sidebar-header {
            padding: 16px;
            font-weight: bold;
            font-size: 1.1rem;
            color: var(--bg-color-header-chat);
            border-bottom: 1px solid var(--border-color);
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .new-chat-btn {
            margin: 10px;
            background-color: var(--new-chat-btn-bg);
            color: var(--text-color-white);
            padding: 10px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .new-chat-btn:hover {
            background-color: var(--new-chat-btn-hover-bg);
        }
        
        .chat-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        .chat-item {
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 6px;
            transition: background-color 0.2s;
        }
        .chat-item:hover {
            background-color: var(--chat-item-hover);
        }
        .chat-item.active {
            background-color: var(--chat-item-active);
            font-weight: bold;
            color: var(--text-color-primary);
        }
        .sidebar-footer {
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .edit-profile-btn {
            background: var(--edit-profile-btn-bg);
            color: var(--text-color-white);
            border: none;
            font-size: 1rem;
            margin: 10px;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .edit-profile-btn:hover {
            background-color: var(--edit-profile-btn-hover-bg);
        }
        .logout-btn {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 1rem;
            margin: 10px;
            margin-top: 0;
            cursor: pointer;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
        }
        .logout-btn:hover {
            background-color: #fbeaea;
        }

        /* ===== Chat container (ì¤‘ì•™ 1) ===== */
        .chat-container {
            flex: 6;
            min-width: 0;
            background: var(--bg-color-chat-container);
            display: flex;
            flex-direction: column;
            position: relative;
            border-right: 1px solid var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .chat-header {
            background-color: var(--bg-color-header-chat);
            color: var(--text-color-white);
            text-align: center;
            padding: 16px;
            font-size: 1.1rem;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: background-color 0.3s ease;
        }
        .chat-header-buttons {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 10px;
        }
        .settings-btn, .dark-mode-toggle-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        .settings-btn:hover, .dark-mode-toggle-btn:hover {
            background: rgba(255,255,255,0.35);
        }
        .chat-body {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message-row {
            display: flex;
            flex-direction: column;
            max-width: 80%;
        }
        .user { align-self: flex-end; text-align: right; }
        .ai { align-self: flex-start; text-align: left; }
        .name-label {
            font-size: 0.8rem;
            color: var(--text-color-secondary);
            margin-bottom: 4px;
            font-weight: bold;
            transition: color 0.3s ease;
        }
        .message-content {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }
        .profile {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        .message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        .ai .message {
            background-color: var(--chat-bubble-ai);
            color: var(--text-color-primary);
            border-bottom-left-radius: 2px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .user .message {
            background-color: var(--chat-bubble-user);
            color: var(--text-color-white);
            border-bottom-right-radius: 2px;
            transition: background-color 0.3s ease;
            word-wrap: break-word;
        }
        .chat-input {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--border-color);
            background-color: var(--bg-color-chat-container);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background-color: var(--bg-color-body);
            color: var(--text-color-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .chat-input button {
            background-color: var(--new-chat-btn-bg);
            color: var(--text-color-white);
            border: none;
            border-radius: 8px;
            margin-left: 8px;
            padding: 10px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .chat-input button:hover {
            background-color: var(--new-chat-btn-hover-bg);
        }
        .settings-panel {
            position: absolute;
            top: 50px;
            right: 16px;
            background: var(--bg-color-sidebar);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px;
            box-shadow: 0 4px 8px var(--shadow-color);
            width: 160px;
            text-align: center;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 100;
        }
        .settings-panel.show {
            opacity: 1;
            transform: translateY(0);
            pointer-events: auto;
        }
        .settings-panel label {
            color: var(--text-color-primary);
        }
        .settings-panel small {
            color: var(--text-color-secondary);
        }
        .settings-panel input[type="file"] {
            width: 100%;
            margin-top: 6px;
            background-color: var(--bg-color-body);
            color: var(--text-color-primary);
            border: 1px solid var(--border-color);
            border-radius: 5px;
        }
        .logout-setting-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            margin-top: 8px;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
        }
        .logout-setting-btn:hover {
            background-color: #c0392b;
        }

        /* ===== Info Panel (ì˜¤ë¥¸ìª½ 1) - êµ¬ì¡° ë° ì „í™˜ ìŠ¤íƒ€ì¼ ìˆ˜ì • ===== */
        .info-panel {
            flex: 4;
            background-color: var(--bg-color-info-panel);
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease;
            min-width: 350px;
        }
        .info-header {
            background-color: var(--bg-color-header-info);
            color: var(--text-color-white);
            text-align: center;
            padding: 16px;
            font-size: 1.1rem;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .info-sub-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--info-sub-header-bg);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #infoToggleBtn {
            background-color: var(--info-toggle-btn-bg);
            color: var(--info-toggle-btn-color);
            padding: 8px 12px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s, color 0.3s, border-color 0.3s;
            border: 1px solid var(--info-toggle-btn-border);
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
        }
        #infoToggleBtn:hover {
            background-color: #dcdcdc;
        }
        .analysis-mode-btn {
            background-color: var(--analysis-mode-btn-bg) !important;
            border-color: var(--analysis-mode-btn-border) !important;
            color: var(--analysis-mode-btn-color) !important;
        }
        .info-content-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }
        .info-section {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 15px;
            overflow-y: auto;
            transition: opacity 0.3s, transform 0.3s;
            background-color: var(--bg-color-info-panel);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }
        .hidden {
            opacity: 0;
            pointer-events: none;
            transform: translateX(100%);
        }
        .visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateX(0);
        }
        .info-content-title {
            font-weight: bold;
            color: var(--text-color-primary);
            border-left: 4px solid var(--bg-color-header-chat);
            padding-left: 8px;
            margin: 0;
            font-size: 1.05rem;
            transition: color 0.3s ease, border-color 0.3s ease;
        }
        .keyword-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding-top: 10px;
            flex-wrap: wrap;
        }
        .keyword-card {
            flex: 1;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            background-color: var(--keyword-card-bg);
            box-shadow: 0 1px 3px var(--shadow-color);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
            min-width: 100px;
        }
        .keyword-label {
            font-size: 0.8rem;
            color: var(--text-color-secondary);
            margin-bottom: 5px;
            font-weight: normal;
            transition: color 0.3s ease;
        }
        .keyword-value {
            font-weight: bold;
            color: var(--bg-color-header-chat);
            font-size: 1rem;
            transition: color 0.3s ease;
        }
        .graph-title {
            margin-top: 25px;
            margin-bottom: 15px;
        }
        .graph-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            flex: 1;
            min-height: 200px;
        }
        .graph-placeholder {
            width: 100%;
            height: 100%;
            background-color: var(--graph-placeholder-bg);
            border: 1px dashed var(--graph-placeholder-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            color: var(--text-color-secondary);
            border-radius: 6px;
            transition: background-color 0.3s ease, border-color 0.3s ease, color 0.3s ease;
        }
        .recommendation-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 5px;
            flex: 1;
            min-height: 0;
        }
        .recommendation-item {
            border: 1px solid var(--recommendation-item-border);
            border-radius: 8px;
            padding: 12px;
            background-color: var(--recommendation-item-bg);
            position: relative;
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .job-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin-bottom: 5px;
            border-bottom: 2px solid #a8c8e8;
            padding-bottom: 3px;
            gap: 5px;
            flex-shrink: 0;
            transition: border-color 0.3s ease;
        }
        .job-title {
            font-weight: bold;
            color: var(--text-color-primary);
            font-size: 1rem;
            margin-bottom: 0;
            border-bottom: none;
            padding-bottom: 0;
            flex-shrink: 1;
            min-width: 0;
            transition: color 0.3s ease;
        }
        .text-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
            padding-top: 5px;
        }
        .reason-label {
            font-size: 0.85rem;
            color: var(--text-color-secondary);
            font-weight: bold;
            flex-shrink: 0;
            margin-bottom: 5px;
            transition: color 0.3s ease;
        }
        .text-content {
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--text-color-primary);
            transition: opacity 0.3s, color 0.3s;
            overflow-y: auto;
            flex: 1;
            padding-right: 5px;
        }
        .text-content.hidden {
            display: none;
        }
        .text-content.current {
            display: block;
        }
        .button-container {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
            position: absolute;
            top: -1px;
            right: -1px;
            border-top-right-radius: 8px;
            border-bottom-left-radius: 8px;
            overflow: hidden;
            z-index: 10;
            box-shadow: -2px 2px 5px var(--shadow-color);
        }
        .toggle-text-btn {
            background: var(--toggle-text-btn-bg);
            color: white;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s, transform 0.1s;
            flex-shrink: 0;
            border-radius: 0;
        }
        .toggle-text-btn:hover {
            background: var(--toggle-text-btn-hover-bg);
        }
        .competition-btn {
            background: var(--competition-btn-bg);
        }
        .competition-btn:hover {
            background: var(--competition-btn-hover-bg);
        }
        .company-btn {
            background: var(--company-btn-bg);
        }
        .company-btn:hover {
            background: var(--company-btn-hover-bg);
        }

        /* ======================================================= */
        /* ëª¨ë‹¬ (íŒì—…) ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        /* ======================================================= */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
        }
        .modal-content {
            background-color: var(--bg-color-sidebar);
            margin: 15% auto;
            padding: 20px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 400px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        body.dark-mode .modal-content {
            background-color: var(--bg-color-sidebar);
            border-color: var(--border-color);
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--text-color-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .modal-content label {
            display: block;
            margin-top: 10px;
            font-weight: bold;
            color: var(--text-color-primary);
            font-size: 0.95rem;
        }
        .modal-content input[type="text"],
        .modal-content input[type="password"] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            box-sizing: border-box;
            background-color: var(--bg-color-body);
            color: var(--text-color-primary);
        }
        .modal-content input[disabled] {
            background-color: var(--chat-bubble-ai);
            opacity: 0.8;
            cursor: not-allowed;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal-buttons button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        #updateProfileBtn {
            background-color: var(--edit-profile-btn-bg);
            color: var(--text-color-white);
        }
        #updateProfileBtn:hover {
            background-color: var(--edit-profile-btn-hover-bg);
        }
        #cancelUpdateBtn {
            background-color: var(--info-toggle-btn-bg);
            color: var(--text-color-primary);
        }
        #cancelUpdateBtn:hover {
            background-color: #ccc;
        }
        #updateStatusMessage {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #e74c3c;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="sidebar-main"> <div class="sidebar-header" id="sidebarTitle">ğŸ’¬ ìƒë‹´ ê¸°ë¡</div>
            <div class="new-chat-btn" id="newChatBtn">+ ìƒˆ ëŒ€í™”</div>
            <div class="chat-list" id="chatList"></div>
        </div>
        <div class="sidebar-footer"> <button class="edit-profile-btn" id="editProfileBtn">ğŸ‘¤ íšŒì› ìˆ˜ì •</button>
            <button class="logout-btn" id="logoutBtn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>
    
    <div class="main-content-wrapper">
        <div class="chat-container">
            <div class="chat-header">
                í•™ìƒì§„ë¡œ ìƒë‹´ ì±—ë´‡
                <div class="chat-header-buttons">
                    <button class="dark-mode-toggle-btn" id="darkModeToggle">
                        <span class="icon">ğŸŒ™</span> </button>
                    <button class="settings-btn" id="settingsBtn">âš™ï¸</button>
                </div>
            </div>
            <div class="settings-panel" id="settingsPanel">
                <label><b>í”„ë¡œí•„ ì„¤ì •</b></label><br/>
                <small>ì´ë¯¸ì§€ ë³€ê²½:</small>
                <input type="file" id="profileInput" accept="image/*" />
                <button class="logout-setting-btn" id="logoutSettingBtn">ğŸšª ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <div class="chat-body" id="chat-body"></div>
            <div class="chat-input">
                <input type="text" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." id="message" />
                <button id="sendBtn">ì „ì†¡</button> </div>
        </div>
        <div class="info-panel">
            <div class="info-header" id="infoHeaderTitle">ğŸ” ë§ì¶¤í˜• ì§„ë¡œ ì •ë³´</div>
            <div class="info-sub-header">
                <div class="info-content-title" id="infoPanelTitle">
                    <span style="color: #666;">ğŸ“Š</span> AI ì¶”ì²œ ì§ì—…
                </div>
                <button id="infoToggleBtn">ğŸ“Š ë¶„ì„ ì •ë³´ ë³´ê¸°</button>
            </div>
            <div class="info-content-wrapper" id="infoContentWrapper">
                <div class="info-section info-section-recommendation visible" id="recommendationPanel">
                    <div class="recommendation-list">
                        </div>
                </div>

                <div class="info-section info-section-analysis hidden" id="analysisPanel">
                    <div class="info-content-title">ğŸ“Š í•™ìƒ ë¶„ì„ ìš”ì•½</div>
                    <div class="keyword-container" id="analysisKeywordContainer">
                        </div>
                    <div class="info-content-title graph-title">ğŸ“ˆ ì§ì—… ì¼ì¹˜ìœ¨ ë¶„ì„ (ê°€ìƒ)</div>
                    <div class="graph-container">
                        <canvas id="jobMatchChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <h2>íšŒì› ì •ë³´ ìˆ˜ì •</h2>
            <div id="updateStatusMessage" style="color: green; margin-bottom: 10px;"></div>
            <label for="modalUserId">ì•„ì´ë”” (ID)</label>
            <input type="text" id="modalUserId" disabled>
            <label for="modalNewPassword">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
            <input type="password" id="modalNewPassword" placeholder="ë³€ê²½í•˜ë ¤ë©´ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            <label for="modalUserName">ì´ë¦„</label>
            <input type="text" id="modalUserName" required>
            <div class="modal-buttons">
                <button id="cancelUpdateBtn">ì·¨ì†Œ</button>
                <button id="updateProfileBtn">ìˆ˜ì • ì™„ë£Œ</button>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================
        // ğŸ’¡ [ë²„ê·¸ ìˆ˜ì •] JavaScript ë¡œì§ (ì½”ë“œ ìˆœì„œ ë³€ê²½ ë° ë²„ê·¸ ìˆ˜ì •)
        // ===================================================================

        // --- 1. DOM ìš”ì†Œ ì„ íƒ ---
        const chatBody = document.getElementById("chat-body");
        const msgInput = document.getElementById("message");
        const sendBtn = document.getElementById("sendBtn");
        const profileInput = document.getElementById("profileInput");
        const settingsBtn = document.getElementById("settingsBtn");
        const settingsPanel = document.getElementById("settingsPanel");
        const logoutBtn = document.getElementById("logoutBtn");
        const logoutSettingBtn = document.getElementById("logoutSettingBtn");
        const newChatBtn = document.getElementById("newChatBtn");
        const chatList = document.getElementById("chatList");
        const infoToggleBtn = document.getElementById("infoToggleBtn");
        const recommendationPanel = document.getElementById("recommendationPanel");
        const analysisPanel = document.getElementById("analysisPanel");
        const darkModeToggle = document.getElementById('darkModeToggle');
        
        const sidebarTitle = document.getElementById("sidebarTitle");
        const infoHeaderTitle = document.getElementById("infoHeaderTitle");
        const infoPanelTitle = document.getElementById("infoPanelTitle");
        const analysisKeywordContainer = document.getElementById("analysisKeywordContainer");
        
        const editProfileBtn = document.getElementById("editProfileBtn");
        const editProfileModal = document.getElementById("editProfileModal");
        const modalUserId = document.getElementById("modalUserId");
        const modalNewPassword = document.getElementById("modalNewPassword");
        const modalUserName = document.getElementById("modalUserName");
        const updateProfileBtn = document.getElementById("updateProfileBtn");
        const cancelUpdateBtn = document.getElementById("cancelUpdateBtn");
        const updateStatusMessage = document.getElementById("updateStatusMessage");

        // --- 2. ì „ì—­ ë³€ìˆ˜ ê´€ë¦¬ ---
        let userName = "í•™ìƒ";
        let userId = null;
        let userProfileSrc = "/static/user-profile.png";
        let conversationHistory = [];
        let chats = [];
        let currentChatIndex = -1;
        let currentConversationId = null;
        let isRecommendationMode = true;
        
        let jobMatchChart = null;

        // --- 3. ğŸ’¡ [ìˆ˜ì •] í—¬í¼ í•¨ìˆ˜ ì •ì˜ (window.onload ë³´ë‹¤ ìœ„ë¡œ ì´ë™) ---

        function updateUserUI(name) {
            userName = name;
            if (sidebarTitle) sidebarTitle.textContent = `ğŸ’¬ ${name} ë‹˜ì˜ ìƒë‹´ ê¸°ë¡`;
            if (infoHeaderTitle) infoHeaderTitle.textContent = `ğŸ” ${name} ë‹˜ì˜ ë§ì¶¤í˜• ì§„ë¡œ ì •ë³´`;
            if (infoPanelTitle) infoPanelTitle.innerHTML = `
                <span style="color: var(--text-color-secondary);">ğŸ“Š</span>
                <span style="display:inline-block; margin-right:5px; font-weight: bold;">${name} ë‹˜ì˜</span> AI ì¶”ì²œ ì§ì—…
            `;
            document.querySelectorAll('.name-label.user').forEach(el => el.textContent = name);
        }

        function addEventListeners() {
            infoToggleBtn?.addEventListener('click', toggleInfoPanel);
            darkModeToggle?.addEventListener('click', toggleDarkMode);
            settingsBtn?.addEventListener('click', () => settingsPanel.classList.toggle("show"));
            profileInput?.addEventListener("change", handleProfileImageChange);
            
            editProfileBtn?.addEventListener('click', openEditProfileModal);
            cancelUpdateBtn?.addEventListener('click', closeEditProfileModal);
            updateProfileBtn?.addEventListener('click', handleUpdateProfile);
            window.addEventListener('click', (event) => {
                if (event.target === editProfileModal) closeEditProfileModal();
            });

            logoutBtn?.addEventListener('click', logout);
            logoutSettingBtn?.addEventListener('click', logout);
            
            newChatBtn?.addEventListener("click", newChat);

            msgInput?.addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendMessage();
            });
            
            sendBtn?.addEventListener("click", sendMessage);
        }

        // ğŸ’¡ [ë²„ê·¸ ìˆ˜ì •] "ë¬´í•œ ëŒ€ë‹µì§€ì˜¥" ë²„ê·¸ ìˆ˜ì •
        async function sendMessage() {
            const msg = msgInput.value.trim();
            if (msg === "") return;
            if (!currentConversationId || !userId) {
                alert("ì˜¤ë¥˜: ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤. 'ìƒˆ ëŒ€í™”'ë¥¼ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
                return;
            }

            addUserMessage(msg);
            msgInput.value = "";
            sendBtn.disabled = true;
            sendBtn.textContent = "...";

            try {
                const res = await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        user_id: userId,
                        user_input: msg,
                        history: conversationHistory,
                        conversation_id: currentConversationId
                    })
                });

                if (!res.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${res.status}`);
                const data = await res.json();

                console.log("âœ… AI ì‘ë‹µ:", data);

                // âœ… 1ï¸âƒ£ ë‹µë³€ ì¶œë ¥
                addAIMessage(data.answer || "ë‹µë³€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

                // âœ… 2ï¸âƒ£ ì¶”ì²œ ì§ì—… / ë¶„ì„ íŒ¨ë„ ì—…ë°ì´íŠ¸
                updateAnalysisPanel(data.keywords, data.recommendations);
                updateInfoPanel(data);

                // âœ… 3ï¸âƒ£ í‚¤ì›Œë“œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸
                if (data.keywords && data.keywords.length > 0) {
                    updateKeywordChart(data.keywords);
                }

                // âœ… 4ï¸âƒ£ íˆìŠ¤í† ë¦¬ ì €ì¥
                conversationHistory = data.new_history || [];
                if (currentChatIndex >= 0) {
                    const currentChat = chats[currentChatIndex];
                    currentChat.history = conversationHistory;
                    currentChat.title =
                        currentChat.title === "ìƒˆ ëŒ€í™”" ? msg.slice(0, 15) : currentChat.title;
                    currentChat.recommendations = data.recommendations;
                    currentChat.keywords = data.keywords;
                    saveChats();
                }
                loadChatList();

            } catch (error) {
                console.error("âŒ ì±—ë´‡ í†µì‹  ì˜¤ë¥˜:", error);
                addAIMessage("ì£„ì†¡í•©ë‹ˆë‹¤, ë©”ì‹œì§€ë¥¼ ì²˜ë¦¬í•˜ëŠ” ì¤‘ì— ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = "ì „ì†¡";
                if (chatBody) chatBody.scrollTop = chatBody.scrollHeight;
            }
        }

        function updateAnalysisPanel(keywords, recommendations) {
            
            if (analysisKeywordContainer) {
                if (!keywords || keywords.length === 0) {
                    analysisKeywordContainer.innerHTML = `
                        <div class="keyword-card">
                            <div class="keyword-label">ë¶„ì„ ë°ì´í„°</div>
                            <div class="keyword-value">ì •ë³´ ì—†ìŒ</div>
                        </div>`;
                } else {
                    analysisKeywordContainer.innerHTML = keywords.map(item => `
                        <div class="keyword-card">
                            <div class="keyword-label">${item.label || 'í•­ëª©'}</div>
                            <div class="keyword-value">${item.value || 'N/A'}</div>
                        </div>
                    `).join('');
                }
            }
            
            if (typeof Chart === 'undefined') {
                console.warn("Chart.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜í”„ë¥¼ ê·¸ë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                const canvas = document.getElementById('jobMatchChart');
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = 'red';
                    ctx.font = '14px "Noto Sans KR"';
                    ctx.fillText('Chart.js ë¡œë”© ì‹¤íŒ¨', 10, 50);
                }
                return;
            }
            
            updateJobMatchGraph(keywords, recommendations);
        }
        
        function updateJobMatchGraph(keywords, recommendations) {
            if (!window.Chart || typeof Chart !== "function") {
                console.warn("Chart.jsê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                return;
            }
            const ctx = document.getElementById('jobMatchChart');
            if (!ctx) return;
            
            const validRecs = (recommendations || []).filter(rec => 
                rec.job && !rec.job.startsWith("ì¶”ì²œ ì§ì—…")
            );
            const validKeywords = (keywords || []).map(k => k.value).filter(Boolean);

            let labels = [];
            let scores = [];
            
            if (validRecs.length > 0 && validKeywords.length > 0) {
                labels = validRecs.map(rec => rec.job);
                scores = validRecs.map(rec => {
                    let score = 0;
                    const combinedText = (rec.job + rec.reason).toLowerCase();
                    validKeywords.forEach(kw => {
                        if (combinedText.includes(kw.toLowerCase())) {
                            score += 1;
                        }
                        if (kw.includes("ì—°ë´‰") && combinedText.includes("ê²Œì„ ê¸°íšì")) {
                             score += 2;
                        }
                    });
                    let finalScore = (1 + score) * (100 / (validKeywords.length + 2));
                    return Math.min(finalScore, 100);
                });
                
            } else {
                labels = ["ì¼ì¹˜ìœ¨ ë°ì´í„° ì—†ìŒ"];
                scores = [0];
            }

            if (jobMatchChart) {
                jobMatchChart.destroy();
            }

            const isDarkMode = document.body.classList.contains('dark-mode');
            const tickColor = isDarkMode ? '#e0e0e0' : '#555';

            jobMatchChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'í•™ìƒ-ì§ì—… ì¼ì¹˜ìœ¨ (ê°€ìƒ)',
                        data: scores,
                        backgroundColor: [
                            'rgba(74, 144, 226, 0.7)',
                            'rgba(92, 184, 92, 0.7)',
                            'rgba(243, 156, 18, 0.7)'
                        ],
                        borderColor: [
                            'rgba(74, 144, 226, 1)',
                            'rgba(92, 184, 92, 1)',
                            'rgba(243, 156, 18, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: tickColor }
                        },
                        y: {
                            ticks: { color: tickColor }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
        function updateKeywordChart(keywords) {
            const chartContainer = document.getElementById("keyword-chart");
            if (!chartContainer) return;

            const values = keywords.map(k => k.value);
            chartContainer.innerHTML = `
                <h4>í•™ìƒ í‚¤ì›Œë“œ ë¶„ì„</h4>
                <ul>${values.map(v => `<li>${v}</li>`).join("")}</ul>
            `;
        }

        function updateInfoPanel(data) {
            if (infoPanelTitle) {
                infoPanelTitle.innerHTML = `
                    <span style="color: var(--text-color-secondary);">ğŸ“Š</span>
                    <span style="display:inline-block; margin-right:5px; font-weight: bold;">${userName} ë‹˜ì˜</span> AI ì¶”ì²œ ì§ì—…
                `;
            }

            const recListContainer = recommendationPanel.querySelector('.recommendation-list');
            if (!recListContainer) return;

            const recs = (data && data.recommendations) ? data.recommendations : [];
            
            let recListHtml = "";
            let drawnCards = 0;

            if (recs.length > 0) {
                recs.forEach((rec, index) => {
                    recListHtml += `
                    <div class="recommendation-item" data-id="${index + 1}">
                        <div class="job-header">
                            <div class="job-title">${rec.job || `ì¶”ì²œ ì§ì—… ${index + 1}`}</div>
                        </div>
                        <div class="button-container">
                            <button class="toggle-text-btn company-btn" data-target="company" data-state="reason">íšŒì‚¬ ë³´ê¸°</button>
                            <button class="toggle-text-btn competition-btn" data-target="competition" data-state="reason">ê²½ìŸë¥  ë³´ê¸°</button>
                            <button class="toggle-text-btn outlook-btn" data-target="outlook" data-state="reason">ì „ë§ ë³´ê¸°</button>
                        </div>
                        <div class="text-area">
                            <div class="reason-label">ì¶”ì²œ ì‚¬ìœ </div>
                            <div class="text-content reason-text current">${rec.reason || 'ì¶”ì²œ ì‚¬ìœ ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            <div class="text-content company-text hidden">${rec.company || 'ê´€ë ¨ íšŒì‚¬ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            <div class="text-content outlook-text hidden">${rec.outlook || 'ì§ì—… ì „ë§ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                            <div class="text-content competition-text hidden">${rec.competition || 'ê²½ìŸë¥  ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.'}</div>
                        </div>
                    </div>
                    `;
                    drawnCards++;
                });
            }

           if (drawnCards < 3) {
                for (let i = drawnCards; i < 3; i++) {
                    recListHtml += ` ... `;
                }
            }
            
            recListContainer.innerHTML = recListHtml;
            
            recListContainer.querySelectorAll('.toggle-text-btn').forEach(button => {
                button.addEventListener('click', (e) => toggleTextContent(e.currentTarget));
            });
        }

        function toggleTextContent(button) {
            const item = button.closest('.recommendation-item');
            if (!item) return;

            const target = button.getAttribute('data-target');
            const currentState = button.getAttribute('data-state');
            const textArea = item.querySelector('.text-area');
            const reasonLabel = textArea.querySelector('.reason-label');
            const textMap = {
                'reason': { element: textArea.querySelector('.reason-text'), label: 'ì¶”ì²œ ì‚¬ìœ ' },
                'outlook': { element: textArea.querySelector('.outlook-text'), label: 'ì§ì—… ì „ë§' },
                'competition': { element: textArea.querySelector('.competition-text'), label: 'ì§ì—… ê²½ìŸë¥ ' },
                'company': { element: textArea.querySelector('.company-text'), label: 'ê´€ë ¨ íšŒì‚¬ ì •ë³´' }
            };

            Object.values(textMap).forEach(info => {
                if (info.element) {
                    info.element.classList.remove('current');
                    info.element.classList.add('hidden');
                }
            });

            const allButtons = item.querySelectorAll('.toggle-text-btn');
            allButtons.forEach(btn => {
                btn.setAttribute('data-state', 'reason');
                const btnTarget = btn.getAttribute('data-target');
                if (btnTarget === 'outlook') btn.textContent = 'ì „ë§ ë³´ê¸°';
                else if (btnTarget === 'competition') btn.textContent = 'ê²½ìŸë¥  ë³´ê¸°';
                else if (btnTarget === 'company') btn.textContent = 'íšŒì‚¬ ë³´ê¸°';
            });

            let newState = (currentState === target) ? 'reason' : target;

            reasonLabel.textContent = textMap[newState].label;
            if(textMap[newState].element) {
                textMap[newState].element.classList.remove('hidden');
                textMap[newState].element.classList.add('current');
            }

            if (newState !== 'reason') {
                button.setAttribute('data-state', newState);
                button.textContent = 'ì‚¬ìœ  ë³´ê¸°';
            }
        }

        function toggleInfoPanel() {
            if (isRecommendationMode) {
                recommendationPanel.classList.remove('visible');
                recommendationPanel.classList.add('hidden');
                analysisPanel.classList.remove('hidden');
                analysisPanel.classList.add('visible');
                infoToggleBtn.textContent = "â¬…ï¸ ì¶”ì²œ ì§ì—… ë³´ê¸°";
                infoToggleBtn.classList.add('analysis-mode-btn');
                infoPanelTitle.innerHTML = `<span style="color: var(--bg-color-header-chat);">ğŸ“Š</span> ${userName} ë‹˜ ë¶„ì„ ìƒì„¸`;
            } else {
                analysisPanel.classList.remove('visible');
                analysisPanel.classList.add('hidden');
                recommendationPanel.classList.remove('hidden');
                recommendationPanel.classList.add('visible');
                infoToggleBtn.textContent = "ğŸ“Š ë¶„ì„ ì •ë³´ ë³´ê¸°";
                infoToggleBtn.classList.remove('analysis-mode-btn');
                infoPanelTitle.innerHTML = `
                    <span style="color: var(--text-color-secondary);">ğŸ“Š</span>
                    <span style="display:inline-block; margin-right:5px; font-weight: bold;">${userName} ë‹˜ì˜</span> AI ì¶”ì²œ ì§ì—…
                `;
            }
            isRecommendationMode = !isRecommendationMode;
        }

        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            if (isDarkMode) {
                localStorage.setItem('theme', 'dark');
                darkModeToggle.querySelector('.icon').textContent = 'â˜€ï¸';
            } else {
                localStorage.setItem('theme', 'light');
                darkModeToggle.querySelector('.icon').textContent = 'ğŸŒ™';
            }
            
            try {
                if (currentChatIndex < 0 || !chats[currentChatIndex]) return;
                updateJobMatchGraph(
                    chats[currentChatIndex]?.keywords || [], 
                    chats[currentChatIndex]?.recommendations || []
                );
            } catch (e) {
                console.error("ë‹¤í¬ëª¨ë“œ ê·¸ë˜í”„ ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:", e);
            }
        }

    

        function handleProfileImageChange(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    userProfileSrc = e.target.result;
                    document.querySelectorAll('.profile.user-img').forEach(img => {
                        img.src = userProfileSrc;
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        // --- 5. íšŒì›ì •ë³´/ëŒ€í™” ì„¸ì…˜ ê´€ë¦¬ í•¨ìˆ˜ ---
        function openEditProfileModal() {
            modalUserId.value = userId;
            modalUserName.value = userName;
            modalNewPassword.value = '';
            updateStatusMessage.textContent = '';
            updateStatusMessage.style.color = 'green';
            editProfileModal.style.display = 'block';
        }

        function closeEditProfileModal() {
            editProfileModal.style.display = 'none';
        }

        async function handleUpdateProfile() {
            const newPassword = modalNewPassword.value;
            const newName = modalUserName.value.trim();

            if (!newName) {
                updateStatusMessage.textContent = 'ì´ë¦„ì€ í•„ìˆ˜ë¡œ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.';
                updateStatusMessage.style.color = 'red';
                return;
            }

            try {
                const response = await fetch("/api/update_profile", { 
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        user_id: userId,
                        new_password: newPassword || null,
                        new_name: newName
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'ì •ë³´ ìˆ˜ì • ì‹¤íŒ¨');
                }
                
                localStorage.setItem("user_name", newName);
                updateUserUI(newName);
                
                updateStatusMessage.textContent = 'íšŒì› ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!';
                updateStatusMessage.style.color = 'green';
                
                setTimeout(closeEditProfileModal, 1500);
                
            } catch (error) {
                console.error("íšŒì› ì •ë³´ ìˆ˜ì • ì˜¤ë¥˜:", error);
                updateStatusMessage.textContent = error.message;
                updateStatusMessage.style.color = 'red';
            }
        }

        function loadChatList() {
            if (!chatList) return;
            chatList.innerHTML = "";
            chats.forEach((chat, index) => {
                const div = document.createElement("div");
                div.classList.add("chat-item");
                if (index === currentChatIndex) div.classList.add("active");
                div.textContent = chat.title;

                div.addEventListener("click", () => {
                    currentChatIndex = index;
                    conversationHistory = chats[index].history;
                    currentConversationId = chats[index].conversationId;
                    
                    const loadedRecs = chats[currentChatIndex].recommendations || [];
                    const loadedKeywords = chats[currentChatIndex].keywords || [];
                    
                    loadChatList();
                    renderChat(conversationHistory);
                    
                    updateInfoPanel({ recommendations: loadedRecs });
                    
                    try {
                        updateAnalysisPanel(loadedKeywords, loadedRecs);
                    } catch (e) {
                        console.error("ê·¸ë˜í”„ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                    }
                });

                div.addEventListener("dblclick", () => {
                    const newTitle = prompt("ìƒˆë¡œìš´ ëŒ€í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:", chat.title);
                    if (newTitle && newTitle.trim() !== "") {
                        chats[index].title = newTitle.trim();
                        saveChats();
                        loadChatList();
                    }
                });
                chatList.appendChild(div);
            });
        }

        function renderChat(history) {
            if (!chatBody) return;
            chatBody.innerHTML = "";
            if (!history || history.length === 0) {
                addAIMessage("ì•ˆë…•í•˜ì„¸ìš”! ì €ëŠ” ì§„ë¡œ ìƒë‹´ì‚¬ AIì˜ˆìš”. ê¶ê¸ˆí•œ ê±¸ í¸í•˜ê²Œ ë¬¼ì–´ë´ìš”!", false);
                return;
            }
            history.forEach(msg => {
                if (msg.role === "student") {
                    addUserMessage(msg.content, false);
                } else if (msg.role === "counselor" || msg.role === "assistant") {
                    addAIMessage(msg.content, false);
                }
            });
        }

        function newChat() {
            if (!userId) {
                alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
            currentConversationId = 'conv_' + Date.now().toString() + '_' + userId;
            conversationHistory = [];

            const newChatEntry = { 
                title: "ìƒˆ ëŒ€í™”", 
                history: [], 
                conversationId: currentConversationId,
                recommendations: [],
                keywords: []
            };
            chats.push(newChatEntry);
            currentChatIndex = chats.length - 1;
            saveChats();
            loadChatList();
            renderChat([]);
            
            updateInfoPanel({ recommendations: [] });
            try {
                updateAnalysisPanel([], []);
            } catch(e) {
                console.error("ìƒˆ ëŒ€í™” ê·¸ë˜í”„ ì´ˆê¸°í™” ì˜¤ë¥˜:", e);
            }
            updateUserUI(userName);
        }

        function logout() {
            localStorage.removeItem("user_id");
            localStorage.removeItem("user_name");
            localStorage.removeItem(`chats_${userId}`);
            window.location.href = "/login.html";
        }

        function saveChats() {
            if (userId) {
                localStorage.setItem(`chats_${userId}`, JSON.stringify(chats));
            }
        }

        // --- 6. ì±„íŒ… ë©”ì‹œì§€ UI ì¶”ê°€ í•¨ìˆ˜ ---
        function addUserMessage(text, scroll = true) {
            const messageRow = document.createElement("div");
            messageRow.classList.add("message-row", "user");
            messageRow.innerHTML = `
                <div class="name-label user-name">${userName}</div>
                <div class="message-content">
                    <div class="message">${text}</div>
                    <img class="profile user-img" src="${userProfileSrc}" alt="${userName} í”„ë¡œí•„" />
                </div>
            `;
            chatBody.appendChild(messageRow);
            if (scroll) chatBody.scrollTop = chatBody.scrollHeight;
        }

        function addAIMessage(text, scroll = true) {
            const messageRow = document.createElement("div");
            messageRow.classList.add("message-row", "ai");
            messageRow.innerHTML = `
                <div class="name-label">AI ìƒë‹´ì‚¬</div>
                <div class="message-content">
                    <img class="profile" src="/static/bot-profile.png" alt="AI í”„ë¡œí•„" />
                    <div class="message">${text}</div>
                </div>
            `;
            chatBody.appendChild(messageRow);
            if (scroll) chatBody.scrollTop = chatBody.scrollHeight;
        }


        // --- 7. ğŸ’¡ [ë²„ê·¸ ìˆ˜ì •] window.onloadë¥¼ ëª¨ë“  í•¨ìˆ˜ ì •ì˜ *ë’¤*ë¡œ ì´ë™ ---
        window.onload = function() {
            try {
                // ğŸ’¡ [ë²„ê·¸ ìˆ˜ì •] DOM ìš”ì†Œê°€ ë¨¼ì € ì„ íƒë˜ë„ë¡ ìƒë‹¨ìœ¼ë¡œ ì´ë™
                const sidebarTitle = document.getElementById("sidebarTitle");
                const infoHeaderTitle = document.getElementById("infoHeaderTitle");
                const infoPanelTitle = document.getElementById("infoPanelTitle");
                const analysisKeywordContainer = document.getElementById("analysisKeywordContainer");
                const recommendationPanel = document.getElementById("recommendationPanel");
                const analysisPanel = document.getElementById("analysisPanel");
                const infoToggleBtn = document.getElementById("infoToggleBtn");
                const darkModeToggle = document.getElementById('darkModeToggle');
                const chatList = document.getElementById("chatList");

                userId = localStorage.getItem('user_id');
                userName = localStorage.getItem('user_name') || 'í•™ìƒ';

                if (!userId) {
                    alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                    window.location.href = "/login.html";
                    return;
                }

                updateUserUI(userName);

                chats = JSON.parse(localStorage.getItem(`chats_${userId}`) || "[]");
                currentChatIndex = chats.length ? chats.length - 1 : -1;

                if (currentChatIndex >= 0) {
                    currentConversationId = chats[currentChatIndex].conversationId;
                    conversationHistory = chats[currentChatIndex].history;
                    renderChat(conversationHistory);
                    
                    const loadedRecs = chats[currentChatIndex].recommendations || [];
                    const loadedKeywords = chats[currentChatIndex].keywords || [];
                    
                    updateInfoPanel({ recommendations: loadedRecs });
                    
                    try {
                        updateAnalysisPanel(loadedKeywords, loadedRecs);
                    } catch (e) {
                        console.error("ê·¸ë˜í”„ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", e);
                    }
                    
                } else {
                    newChat();
                }

                recommendationPanel.classList.add('visible');
                analysisPanel.classList.add('hidden');
                infoToggleBtn.classList.remove('analysis-mode-btn');

                if (localStorage.getItem('theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    if (darkModeToggle) darkModeToggle.querySelector('.icon').textContent = 'â˜€ï¸';
                } else {
                    if (darkModeToggle) darkModeToggle.querySelector('.icon').textContent = 'ğŸŒ™';
                }

                loadChatList();
                
            } catch (error) {
                console.error("ì´ˆê¸°í™” ì¤‘ ì¹˜ëª…ì  ì˜¤ë¥˜:", error);
                alert("í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. (window.onload) \n\n" + error.message);
            }
            
            addEventListeners();
        }

    </script>
</body>
</html>